<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title><%= appTitle %></title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <link rel="stylesheet" href="/public/css/app.css" />
  <link rel="stylesheet" href="/public/css/style.css" />
<!-- añadidas para el logo -->
  <link rel="shortcut icon" href="/public/favicon.png" type="image/x-icon">
  <link rel="icon" href="/public/favicon.png" type="image/x-icon">

</head>
<body>
  <header class="app-header">
    <img src="<%= headerBanner %>" alt="Cabecera" class="header-banner" style="max-height: 90px; width: auto;" />
   <!--  <div class="brand">
      <img src="/public/img/logo1.jpg" height="100" width="100" alt="Logo"  />
      <%= brandName %>
    </div> -->
  </header>
  <nav class="topnav">
    <% if (user) { %>
      <a href="/">Inicio</a>
      <a href="/tickets">Boletos semana</a>
      <a href="/movimientos">Estado de cuentas</a>
      <a href="/perfil">Mi perfil</a>
      <% if (user.tipo === 'admin') { %>
        <a href="/admin">Mantenimiento</a>
      <% } %>
      <form method="post" action="/logout" style="display:inline"><button class="linklike">Salir (<%= user.nombre %>)</button></form>
    <% } else { %>
      <a href="/login">Acceder</a>
    <% } %>
  </nav>

  <% if (flash) { %>
    <div class="flash <%= flash.type %>"><%= flash.msg %></div>
  <% } %>

  <main class="container">
    <%- body %>
  </main>
  
  <!-- Modal para ampliar imágenes -->
  <div class="modal fade" id="imgModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
      <div class="modal-content position-relative" style="background: rgba(0,0,0,.6); border: none;">
        <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-2" data-bs-dismiss="modal" aria-label="Close"></button>
        <a id="imgDownload" class="btn btn-sm btn-light position-absolute top-0 start-0 m-2" href="#" download>Descargar</a>
        <button id="imgPrev" type="button" class="btn btn-light position-absolute top-50 start-0 translate-middle-y ms-2" aria-label="Anterior">&lsaquo;</button>
        <button id="imgNext" type="button" class="btn btn-light position-absolute top-50 end-0 translate-middle-y me-2" aria-label="Siguiente">&rsaquo;</button>
        <div class="modal-body p-2 text-center">
          <img id="imgModalPicture" src="" alt="vista ampliada" class="img-fluid" style="max-height: 85vh;" />
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (function(){
      var modalEl = document.getElementById('imgModal');
      var imgEl = document.getElementById('imgModalPicture');
      var btnPrev = document.getElementById('imgPrev');
      var btnNext = document.getElementById('imgNext');
      var aDownload = document.getElementById('imgDownload');
      if (!modalEl || !imgEl || !btnPrev || !btnNext || !aDownload) return;

      var current = { group: null, index: 0, list: [] };

      function collectGroup(group){
        var nodes = Array.prototype.slice.call(document.querySelectorAll('img.zoomable[data-group="'+group+'"]'));
        return nodes;
      }
      function filenameFromSrc(src){ try { return src.split('/').pop() || 'boleto.jpg'; } catch(_) { return 'boleto.jpg'; } }
      function showCurrent(){
        if (!current.list.length) return;
        var img = current.list[current.index];
        var src = img.getAttribute('src');
        imgEl.src = src;
        aDownload.href = src;
        aDownload.download = filenameFromSrc(src);
      }
      function openFrom(target){
        var group = target.getAttribute('data-group') || 'all';
        current.group = group;
        current.list = collectGroup(group);
        var idx = parseInt(target.getAttribute('data-index') || '0', 10);
        if (isNaN(idx)) idx = Math.max(0, current.list.indexOf(target));
        current.index = Math.min(Math.max(idx,0), Math.max(current.list.length-1,0));
        showCurrent();
        try {
          var modal = bootstrap && bootstrap.Modal ? bootstrap.Modal.getOrCreateInstance(modalEl) : null;
          if (modal) modal.show();
        } catch(e) {}
      }

      document.addEventListener('click', function(ev){
        var t = ev.target;
        if (t && t.matches('img.zoomable')) {
          openFrom(t);
        }
      });
      btnPrev.addEventListener('click', function(){
        if (!current.list.length) return;
        current.index = (current.index - 1 + current.list.length) % current.list.length;
        showCurrent();
      });
      btnNext.addEventListener('click', function(){
        if (!current.list.length) return;
        current.index = (current.index + 1) % current.list.length;
        showCurrent();
      });
      modalEl.addEventListener('hidden.bs.modal', function(){ current.group=null; current.index=0; current.list=[]; imgEl.removeAttribute('src'); });
      document.addEventListener('keydown', function(e){
        var isShown = modalEl.classList.contains('show');
        if (!isShown) return;
        if (e.key === 'ArrowLeft') { e.preventDefault(); btnPrev.click(); }
        if (e.key === 'ArrowRight') { e.preventDefault(); btnNext.click(); }
      });
    })();
  </script>
</body>
</html>
