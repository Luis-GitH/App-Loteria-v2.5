<section class="ticket-add card p-4">
  <h2>Añadir boleto desde el móvil</h2>
  <p>Sigue los pasos: primero adjunta la foto del boleto y después lee el QR con la cámara. Cuando ambos pasos estén completos podrás guardar el boleto en la base de datos.</p>

  <form id="ticketAddForm" method="post" action="/boletos/nuevo" enctype="multipart/form-data">
    <div class="mb-3">
      <label for="ticketPhoto" class="form-label">Foto del boleto</label>
      <input id="ticketPhoto" name="foto" type="file" accept="image/*" capture="environment" required class="form-control">
      <small class="text-muted">Usa una foto nítida donde se vea completo el boleto.</small>
      <div id="photoPreview" class="mt-3" style="display:none;">
        <img src="" alt="Vista previa" class="img-fluid rounded border">
      </div>
    </div>

    <input type="hidden" name="qrData" id="qrDataField">
    <div class="mb-3">
      <label class="form-label d-block">Lectura de QR</label>
      <p id="qrStatus" class="text-muted mb-2">Pendiente de escanear.</p>
      <div id="qr-reader" class="qr-reader"></div>
      <button id="restartScan" type="button" class="btn mt-2" style="display:none;">Volver a escanear</button>
    </div>

    <div class="d-flex gap-2">
      <button id="submitTicketBtn" type="submit" class="btn" disabled>Guardar boleto</button>
      <a class="btn" href="/tickets">Cancelar</a>
    </div>
  </form>
</section>

<script src="/public/vendor/html5-qrcode.min.js"></script>
<script>
  (function () {
    const photoInput = document.getElementById('ticketPhoto');
    const photoPreview = document.getElementById('photoPreview');
    const previewImg = photoPreview ? photoPreview.querySelector('img') : null;
    const qrField = document.getElementById('qrDataField');
    const qrStatus = document.getElementById('qrStatus');
    const submitBtn = document.getElementById('submitTicketBtn');
    const restartBtn = document.getElementById('restartScan');
    const readerId = 'qr-reader';

    function updateSubmitState() {
      const hasPhoto = photoInput && photoInput.files && photoInput.files.length > 0;
      const hasQR = qrField && qrField.value.trim().length > 0;
      if (submitBtn) submitBtn.disabled = !(hasPhoto && hasQR);
    }

    if (photoInput && previewImg) {
      photoInput.addEventListener('change', function () {
        if (this.files && this.files[0]) {
          const url = URL.createObjectURL(this.files[0]);
          previewImg.src = url;
          photoPreview.style.display = 'block';
        } else {
          photoPreview.style.display = 'none';
          previewImg.removeAttribute('src');
        }
        updateSubmitState();
      });
    }

    if (!window.Html5Qrcode) {
      if (qrStatus) qrStatus.textContent = 'No se pudo cargar el lector de QR.';
      return;
    }

    const html5QrCode = new Html5Qrcode(readerId);
    let scannerRunning = false;

    function startScanner() {
      if (!qrStatus) return;
      Html5Qrcode.getCameras()
        .then((devices) => {
          if (!devices || !devices.length) {
            qrStatus.textContent = 'No se encontró ninguna cámara disponible.';
            return;
          }
          const backCam = devices.find((d) => /back|rear|environment|atrás|trase/i.test(d.label)) || devices[0];
          html5QrCode
            .start(
              { deviceId: { exact: backCam.id } },
              { fps: 8, qrbox: { width: 240, height: 240 }, aspectRatio: 1 },
              onScanSuccess,
              () => {
                if (!scannerRunning) qrStatus.textContent = 'Buscando códigos QR...';
              }
            )
            .then(() => {
              scannerRunning = true;
              qrStatus.textContent = 'Apunta la cámara al QR del boleto.';
            })
            .catch(() => {
              qrStatus.textContent = 'No se pudo iniciar la cámara. Comprueba los permisos.';
            });
        })
        .catch(() => {
          qrStatus.textContent = 'No se pudo acceder a la cámara. Comprueba los permisos.';
        });
    }

    function onScanSuccess(text) {
      if (!text) return;
      qrField.value = text;
      qrStatus.textContent = 'QR capturado correctamente.';
      updateSubmitState();
      restartBtn.style.display = 'inline-block';
      html5QrCode.stop().then(() => { scannerRunning = false; }).catch(() => { scannerRunning = false; });
    }

    if (restartBtn) {
      restartBtn.addEventListener('click', () => {
        qrField.value = '';
        qrStatus.textContent = 'Reiniciando escáner...';
        updateSubmitState();
        startScanner();
        restartBtn.style.display = 'none';
      });
    }

    startScanner();

    window.addEventListener('beforeunload', () => {
      html5QrCode.stop().catch(() => {});
    });
  })();
</script>
