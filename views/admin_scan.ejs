<section class="admin-scan">
  <div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-3">
    <div>
      <h2>Escanear boleto</h2>
      <p>Escanea el código QR desde la cámara del dispositivo y comprueba si tiene premio.</p>
      <p>Hay que permitir el acceso a la cámara</p>
    </div>
    <a class="btn" href="/admin">&larr; Volver al mantenimiento</a>
  </div>

  <div class="card p-4 mb-4">
    <div id="qr-reader" class="qr-reader"></div>
    <p id="scan-feedback" class="mt-3 text-muted">Concede permiso a la c&aacute;mara y apunta al QR del boleto.</p>
    <div class="mt-3">
      <label class="form-label fw-bold" for="qrFileInput">¿No se abre la cámara? Sube una foto del boleto:</label>
      <input id="qrFileInput" class="form-control" type="file" accept="image/*" capture="environment">
      <small class="text-muted d-block mt-1">Puedes tomar una foto y la leeremos directamente. Si falla, la cámara seguirá activa.</small>
    </div>
  </div>

  <form id="scan-result-form" method="post" action="/admin/escanear/resultado" class="d-none">
    <input type="hidden" name="qrData" id="qrDataField" />
  </form>
</section>

<script src="/public/vendor/html5-qrcode.min.js"></script>
<script>
  (function () {
    const readerId = 'qr-reader';
    const feedbackEl = document.getElementById('scan-feedback');
    const formEl = document.getElementById('scan-result-form');
    const qrField = document.getElementById('qrDataField');
    if (!window.Html5Qrcode) {
      feedbackEl.textContent = 'No se pudo cargar el lector de QR.';
      return;
    }
    if (!formEl || !qrField) {
      feedbackEl.textContent = 'No se pudo preparar el formulario de resultados. Recarga la p\u00e1gina.';
      return;
    }

    const html5QrCode = new Html5Qrcode(readerId);
    let lastText = null;
    let isSubmitting = false;
    const fileInput = document.getElementById('qrFileInput');

    function submitResult(decodedText) {
      if (!formEl || !qrField) return;
      feedbackEl.textContent = 'QR detectado, abriendo resultado...';
      qrField.value = decodedText;
      const finalize = () => formEl.submit();
      html5QrCode.stop().then(finalize).catch(() => finalize());
    }

    function onScanSuccess(decodedText) {
      if (isSubmitting || !decodedText) return;
      if (lastText && decodedText === lastText) return;
      isSubmitting = true;
      lastText = decodedText;
      submitResult(decodedText);
    }

    function onScanFailure() {
      if (!isSubmitting) feedbackEl.textContent = 'Buscando c\u00f3digos QR...';
    }

    async function scanFile(file) {
      if (!file) return;
      feedbackEl.textContent = 'Leyendo foto del boleto...';
      try {
        const result = await html5QrCode.scanFileV2(file, true);
        if (result?.text) {
          submitResult(result.text);
        } else {
          feedbackEl.textContent = 'No se encontró QR en la foto. Sigue con la cámara.';
        }
      } catch (err) {
        feedbackEl.textContent = 'No se pudo leer el QR en la foto. Sigue con la cámara.';
      }
    }

    Html5Qrcode.getCameras()
      .then((devices) => {
        if (!devices || !devices.length) {
          feedbackEl.textContent = 'No se encontr\u00f3 ninguna c\u00e1mara disponible.';
          return;
        }
        const backCamera = devices.find((d) => /back|rear|environment|atr\u00e1s|trase/i.test(d.label)) || devices[0];
        html5QrCode
          .start(
            { deviceId: { exact: backCamera.id } },
            { fps: 8, qrbox: { width: 260, height: 260 }, aspectRatio: 1 },
            onScanSuccess,
            onScanFailure
          )
          .then(() => {
            feedbackEl.textContent = 'Apunta la c\u00e1mara al QR del boleto.';
          })
          .catch(() => {
            feedbackEl.textContent = 'No se pudo iniciar la c\u00e1mara. Comprueba los permisos del navegador.';
          });
      })
      .catch(() => {
        feedbackEl.textContent = 'No se pudo acceder a la c\u00e1mara. Comprueba los permisos.';
      });

    window.addEventListener('beforeunload', () => {
      html5QrCode.stop().catch(() => {});
    });

    if (fileInput) {
      fileInput.addEventListener('change', (ev) => {
        const file = ev.target.files?.[0];
        if (file) {
          scanFile(file);
        }
      });
    }
  })();
</script>
